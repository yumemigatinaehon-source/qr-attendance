<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>出席記録</title>
</head>
<body>
<h2 id="title">出席記録ページ</h2>

<div id="inputDiv">
  <label>出席番号を入力してください：</label>
  <input type="text" id="studentInput">
  <button onclick="saveStudentId()">送信</button>
</div>

<p id="status"></p>

<script>
const params = new URLSearchParams(location.search);
const room = params.get("room") || "不明";
const action = params.get("action") === "in" ? "入室" :
               params.get("action") === "out" ? "退室" : "不明";

function getCookie(name) {
  const value = document.cookie.split('; ').find(c => c.startsWith(name + "="));
  return value ? value.split('=')[1] : null;
}

function saveCookie(name, value) {
  document.cookie = `${name}=${value}; path=/; max-age=31536000`; // 1年有効
}

function saveStudentId() {
  const input = document.getElementById("studentInput").value.trim();
  if (!input) { alert("出席番号を入力してください"); return; }
  saveCookie("studentId", input);
  document.getElementById("inputDiv").style.display = "none";
  recordAttendance(input);
}

// 初回アクセスか確認
const studentId = getCookie("studentId");
if (studentId) {
  document.getElementById("inputDiv").style.display = "none";
  recordAttendance(studentId);
}

async function recordAttendance(id) {
  document.getElementById("status").textContent = "記録中...";
  const res = await fetch("/api/record", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ studentId: id, room, action })
  });
  const msg = await res.text();
  document.getElementById("status").textContent = msg;
}
</script>
</body>
</html>

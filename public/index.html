<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>出席確認</title>
</head>
<body>
  <h2 id="title">教室 出席ページ</h2>

  <div id="inputDiv">
    <label>出席番号を入力してください：</label>
    <input type="text" id="studentInput">
    <button onclick="saveStudentId()">送信</button>
  </div>

  <p id="status"></p>
  <button id="changeBtn" onclick="showInput()" style="display:none;">出席番号を変更</button>

  <script>
    const params = new URLSearchParams(location.search);
    const room = params.get("room") || "不明";
    const action = params.get("action"); // "in" または "out"

    document.getElementById("title").textContent = `教室 ${room} 出席ページ`;

    function getCookie(name) {
      const value = document.cookie.split('; ').find(c => c.startsWith(name + "="));
      return value ? value.split('=')[1] : null;
    }

    function saveCookie(name, value) {
      document.cookie = `${name}=${value}; path=/; max-age=31536000`;
    }

    function showInput() {
      document.getElementById("inputDiv").style.display = "block";
      document.getElementById("changeBtn").style.display = "none";
    }

    function saveStudentId() {
      const input = document.getElementById("studentInput").value.trim();
      if (!input) { alert("出席番号を入力してください"); return; }
      saveCookie("studentId", input);
      document.getElementById("inputDiv").style.display = "none";
      document.getElementById("changeBtn").style.display = "inline";
      recordAttendance(input);
    }

    async function recordAttendance(id) {
      if (!action) return; // action パラメータがなければ何もしない
      const time = new Date().toLocaleString("ja-JP");
      await fetch("/api/record", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ room, studentId: id, action: action === "in" ? "入室" : "退室", time })
      });
      document.getElementById("status").textContent = `${action === "in" ? "入室" : "退室"} を記録しました (${time})`;
    }

    const studentId = getCookie("studentId");
    if (studentId) {
      document.getElementById("inputDiv").style.display = "none";
      document.getElementById("changeBtn").style.display = "inline";
      recordAttendance(studentId);
    } else {
      document.getElementById("inputDiv").style.display = "block";
    }
  </script>
</body>
</html>
